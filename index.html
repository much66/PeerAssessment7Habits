<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peer Assessment - Worldwhite Enterprise</title>
    <link rel="icon" href="LOGO news.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0f2c59; --secondary: #dac0a3; --accent: #3498db; --bg: #f0f2f5; --card-bg: #ffffff; --text: #333333; --border: #e1e4e8; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; padding: 0; 
            line-height: 1.6; 
            min-height: 100vh; 
            display: flex; flex-direction: column; 
            -webkit-font-smoothing: antialiased; 
        }
        
        header { background: #fff; padding: 15px 0; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .logo-img { height: 40px; width: auto; object-fit: contain; }
        .logo-text { font-size: 1.1rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; flex: 1; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 40px; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        
        .btn { display: block; width: 100%; padding: 16px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 20px; transition: background 0.2s; touch-action: manipulation; }
        .btn:hover { background-color: #1a4a8d; }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); width: 100%; padding: 16px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--primary); }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 15px; font-family: 'Poppins', sans-serif; background-color:white; }
        .form-group input:focus { border-color: var(--accent); outline: none; }
        .form-group input:disabled { background-color: #f5f5f5; cursor: not-allowed; }

        /* CUSTOM DROPDOWN LIST */
        .custom-dropdown-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid var(--border); border-top: none;
            border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto;
            z-index: 1000; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .custom-dropdown-item {
            padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem;
        }
        .custom-dropdown-item:last-child { border-bottom: none; }
        .custom-dropdown-item:hover { background-color: #f0f8ff; color: var(--primary); }

        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-divider { display: flex; align-items: center; justify-content: center; margin: 25px 0; gap: 10px; width: 100%; }
        .section-divider span { padding: 0; color: #999; font-size: 0.8rem; font-weight: 600; white-space: nowrap; background: transparent; text-align: center; }
        .section-divider::before, .section-divider::after { content: ""; flex: 1; border-top: 2px dashed #eee; height: 1px; min-width: 20px; }
        
        .section-header { 
            background: var(--secondary); 
            color: var(--primary); 
            padding: 15px 20px; 
            border-radius: 8px; 
            font-weight: 700; 
            font-size: 1.1rem; 
            margin: 30px 0 20px 0; 
            display: flex; align-items: center; flex-direction: row; 
        }
        .section-header::before { content: ''; display: block; width: 6px; height: 24px; background-color: var(--primary); border-radius: 4px; margin-right: 15px; flex-shrink: 0; }

        .question-item { background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .question-text { font-size: 1.05rem; margin-bottom: 20px; text-align: justify; font-weight: 500; color: #2c3e50; }
        
        /* SKALA LIKERT - DESKTOP */
        .scale-line-wrapper { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-top: 10px; }
        .scale-label-side { font-size: 0.8rem; font-weight: 600; flex: 0 0 75px; text-align: center; line-height: 1.2; }
        .scale-label-left { color: #e74c3c; } .scale-label-right { color: #27ae60; }
        
        .scale-options { flex-grow: 1; display: flex; justify-content: space-between; position: relative; padding: 0 5px; align-items: center; height: 36px; }
        .scale-track { position: absolute; top: 50%; left: 5px; right: 5px; height: 3px; background: #d1d5db; z-index: 1; transform: translateY(-50%); border-radius: 2px; }
        .scale-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; z-index: 2; margin: 0; width: 24px; }
        .scale-option input { width: 20px; height: 20px; accent-color: var(--primary); margin: 0; cursor: pointer; background-color: #fff; border: 2px solid #ccc; border-radius: 50%; }

        /* RESULT CHART STYLING */
        .result-row { display: flex; align-items: center; margin-bottom: 15px; background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 12px; padding: 20px; }
        .result-label { flex: 0 0 40%; font-weight: 500; padding-right: 15px; color: var(--primary); }
        .result-bar-area { flex: 1; background: #e0e0e0; height: 12px; border-radius: 6px; overflow: hidden; }
        .result-bar-fill { height: 100%; transition: width 1s ease-in-out; }
        .result-score { width: 50px; text-align: right; font-weight: 700; font-size: 1.1rem; }

        .final-score-box { background: linear-gradient(135deg, var(--primary), #1a4a8d); color: white; padding: 15px 25px; border-radius: 12px; text-align: center; margin-top: 30px; }
        
        /* --- MOBILE OPTIMIZATION --- */
        @media screen and (max-width: 768px) {
            .container { padding: 10px 10px; margin: 0 auto; } 
            .card { padding: 20px 15px; margin-bottom: 15px; border-radius: 10px; }
            
            h1 { font-size: 1.3rem; margin-bottom: 5px; line-height: 1.3; }
            .logo-text { font-size: 0.95rem; }
            p { font-size: 0.9rem; }
            
            /* Smaller Habits Header on Mobile */
            .section-header { font-size: 0.85rem; padding: 10px 15px; } 

            .form-group { margin-bottom: 15px; }
            .form-group label { font-size: 0.9rem; margin-bottom: 4px; }
            .form-group input, .form-group select { padding: 10px; font-size: 16px; height: auto; }

            .question-item { padding: 15px; margin-bottom: 15px; border-radius: 8px; }
            .question-text { font-size: 0.85rem; line-height: 1.5; margin-bottom: 15px; text-align: justify; }

            .scale-line-wrapper { gap: 5px; align-items: center; }
            .scale-label-side { flex: 0 0 50px; font-size: 0.6rem; line-height: 1.1; word-wrap: break-word; }
            .scale-label-left { text-align: center; }
            .scale-label-right { text-align: center; }
            .scale-options { flex-grow: 1; padding: 0 2px; }
            .scale-option { width: auto; flex: 1; }
            .scale-option input { width: 20px; height: 20px; }

            .result-row { flex-wrap: wrap; gap: 5px; padding: 12px; }
            .result-label { flex: 0 0 100%; width: 100%; margin-bottom: 5px; font-size: 0.9rem; padding-right: 0; }
            .result-bar-area { flex: 1; height: 10px; }
            .result-score { flex: 0 0 40px; margin-left: 10px; font-size: 1rem; text-align: right; }
            
            .btn, .btn-outline { font-size: 1rem; padding: 12px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="Logo_WE.jpg" alt="Logo" class="logo-img" onerror="this.style.display='none'">
            <div class="logo-text">Worldwhite Enterprise</div>
        </div>
    </header>

    <div class="container">
        
        <!-- 1. INTRO & SELECTION -->
        <div id="introPage" class="page-section active">
            <div class="card">
                <h1 style="color:#0f2c59; text-align:center; font-weight:700;">Peer Assessment</h1>
                <p style="text-align:center; color:#666; font-weight:400;">Based on 7 Habits by Stephen Covey</p>
                <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                
                <div class="form-group">
                    <label>Select Your Group</label>
                    <input type="text" id="groupSearchInput" placeholder="Type to search your Group..." autocomplete="off" oninput="filterGroupList()" onfocus="filterGroupList()">
                    <div id="groupDropdown" class="custom-dropdown-list"></div>
                </div>

                <div class="section-divider"><span>WHO ARE YOU ASSESSING?</span></div>

                <div class="form-group">
                    <label>Target Name (Anggota Group)</label>
                    <input type="text" id="targetSearchInput" placeholder="Select Group first..." autocomplete="off" oninput="filterTargetList()" onfocus="filterTargetList()" disabled>
                    <div id="targetDropdown" class="custom-dropdown-list"></div>

                    <input type="hidden" id="targetName">
                    <input type="hidden" id="targetEmail">
                    <input type="hidden" id="targetPhone">
                    <input type="hidden" id="targetTeam">
                </div>

                <div id="loadingMsg" style="text-align:center; color: #0f2c59; display:none; margin-top:20px;">Loading Data form Spreadsheet...</div>

                <button class="btn" id="startBtn" onclick="initSurvey()" disabled>Start Assessment</button>
            </div>
        </div>

        <!-- 2. SURVEY -->
        <div id="surveyPage" class="page-section">
            <div class="card" style="padding: 20px; background: #e8f5e9; border: 1px solid #c8e6c9;">
                <h3 style="margin:0 0 10px 0; color: #2e7d32;">Based on 7 Habits</h3>
                <p style="margin:0; font-size:0.9rem;">
                    <strong>Assessing Group:</strong> <span id="displayGroup"></span><br>
                    <strong>Target:</strong> <span id="displayTarget"></span>
                </p>
            </div>
            
            <button class="btn-outline" style="border: 1px solid #e74c3c; color: #e74c3c; margin-bottom: 20px;" onclick="cancelAssessment()">
                &larr; Cancel / Kembali
            </button>

            <div id="questionsContainer"></div>
            <div class="card">
                <button class="btn btn-submit-final" onclick="calculateAndSubmit()">Submit Assessment</button>
                <p id="errorMsg" style="color:red; text-align:center; display:none; margin-top: 10px;">Mohon isi semua pertanyaan!</p>
            </div>
        </div>

        <!-- 3. RESULT -->
        <div id="resultPage" class="page-section">
            <div class="card">
                <h2 style="text-align:center; color:#0f2c59; font-weight:700;">Submission Successful</h2>
                <div style="text-align:center; margin:20px 0;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">âœ…</div>
                    <p>Penilaian untuk <strong id="resTargetName"></strong> berhasil disimpan.</p>
                </div>

                <div class="section-divider"><span>SUMMARY SCORE</span></div>
                <div id="resultSummaryChart" style="margin-bottom: 30px;"></div>

                <div class="final-score-box">
                    <div style="font-weight:600;">OVERALL SCORE</div>
                    <div id="finalScoreDisplay" style="font-size:3rem; font-weight:700;">0</div>
                </div>
                
                <div class="section-divider" style="margin-top: 40px;"><span>DETAIL JAWABAN ANDA</span></div>
                
                <button id="btnToggleDetail" class="btn-outline" style="margin-bottom: 20px; font-size: 0.9rem; padding: 12px;" onclick="toggleDetails()">
                    Lihat Detail Jawaban &#9660;
                </button>
                
                <div id="resultDetailAnswers" style="display: none;"></div>

                <button class="btn" style="margin-top: 30px;" onclick="continueAssessment()">Assess Next Member</button>
                <button class="btn btn-outline" onclick="location.reload()">Back to Home</button>
            </div>
        </div>

    </div>

    <script src="api_handler.js"></script>
    <script>
        const categoryOrder = [
            "Habit 1: Be Proactive", "Habit 2: Begin with the End in Mind", "Habit 3: Put First Things First",
            "Emotional Bank Account", "Habit 4: Think Win-Win", "Habit 5: Seek First to Understand Then to Be Understood",
            "Habit 6: Synergize", "Habit 7: Sharpen the Saw"
        ];
        
        let employeesData = []; 
        let fetchedQuestions = [];
        let uniqueGroups = [];
        let submittedPairs = []; 
        
        let selectedGroup = "";
        let selectedTarget = null;
        let eligibleTargets = [];

        // --- INIT ---
        window.onload = async function() {
            document.getElementById('loadingMsg').style.display = 'block';
            
            const [questions, employees, submitted] = await Promise.all([
                fetchQuestionsFromSheet(),
                fetchEmployees(),
                fetchSubmittedPairs()
            ]);

            fetchedQuestions = questions;
            employeesData = employees;
            submittedPairs = submitted || [];

            if (employeesData.length > 0 && fetchedQuestions.length > 0) {
                uniqueGroups = [...new Set(employeesData.map(e => e.team))].sort();
                
                document.getElementById('loadingMsg').style.display = 'none';
                
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#groupSearchInput')) {
                        document.getElementById('groupDropdown').style.display = 'none';
                        validateGroupInput();
                    }
                    if (!e.target.closest('#targetSearchInput')) {
                        document.getElementById('targetDropdown').style.display = 'none';
                        validateTargetInput();
                    }
                });
            } else { alert("Gagal memuat data dari Spreadsheet. Pastikan tab KARYAWAN & Questions ada."); }
        };

        // --- GROUP SEARCHABLE DROPDOWN ---
        function filterGroupList() {
            const input = document.getElementById('groupSearchInput');
            const dropdown = document.getElementById('groupDropdown');
            const filter = input.value.toLowerCase();
            
            dropdown.innerHTML = "";
            const filtered = uniqueGroups.filter(g => g && g.toLowerCase().includes(filter));
            
            if (filtered.length > 0) {
                filtered.forEach(g => {
                    const div = document.createElement('div');
                    div.className = "custom-dropdown-item";
                    div.innerHTML = `<strong>${g}</strong>`;
                    div.onclick = function() { selectGroup(g); };
                    dropdown.appendChild(div);
                });
                dropdown.style.display = "block";
            } else { dropdown.style.display = "none"; }
        }

        function selectGroup(groupName) {
            const input = document.getElementById('groupSearchInput');
            input.value = groupName;
            document.getElementById('groupDropdown').style.display = 'none';
            selectedGroup = groupName;
            
            const targetInput = document.getElementById('targetSearchInput');
            targetInput.value = "";
            targetInput.disabled = false;
            targetInput.placeholder = "Type to search member...";
            selectedTarget = null;
            document.getElementById('startBtn').disabled = true;

            updateEligibleTargets();
        }

        function validateGroupInput() {
            const input = document.getElementById('groupSearchInput');
            if (!selectedGroup || input.value !== selectedGroup) {
                const exactMatch = uniqueGroups.find(g => g === input.value);
                if (exactMatch) selectGroup(exactMatch);
                else {
                    input.value = "";
                    selectedGroup = "";
                    document.getElementById('targetSearchInput').disabled = true;
                }
            }
        }

        // --- TARGET SEARCHABLE DROPDOWN (FILTER LOGIC - BY NAME) ---
        function updateEligibleTargets() {
            // Filter berdasarkan NAMA (target), bukan email
            // Backend mengirim: { assessor: "group...", target: "NAMA TARGET" }
            const alreadyAssessedNames = submittedPairs
                .filter(p => p.assessor === selectedGroup.toLowerCase())
                .map(p => p.target); 

            // Filter karyawan: Satu tim DAN Namanya belum ada di daftar assessed
            eligibleTargets = employeesData.filter(e => 
                e.team === selectedGroup && 
                !alreadyAssessedNames.includes(e.name.toLowerCase().trim())
            );
            
            const targetInput = document.getElementById('targetSearchInput');
            if (eligibleTargets.length === 0) {
                targetInput.disabled = true;
                targetInput.placeholder = "All members in this group have been assessed.";
            } else {
                targetInput.placeholder = "Type to search member...";
                targetInput.disabled = false;
            }
        }

        function filterTargetList() {
            const input = document.getElementById('targetSearchInput');
            const dropdown = document.getElementById('targetDropdown');
            const filter = input.value.toLowerCase();
            
            dropdown.innerHTML = "";
            const filtered = eligibleTargets.filter(e => e.name.toLowerCase().includes(filter));
            
            if (filtered.length > 0) {
                filtered.forEach(e => {
                    const div = document.createElement('div');
                    div.className = "custom-dropdown-item";
                    div.innerHTML = `<strong>${e.name}</strong>`;
                    div.onclick = function() { selectTarget(e); };
                    dropdown.appendChild(div);
                });
                dropdown.style.display = "block";
            } else { dropdown.style.display = "none"; }
        }

        function selectTarget(emp) {
            const input = document.getElementById('targetSearchInput');
            input.value = emp.name;
            document.getElementById('targetDropdown').style.display = 'none';
            selectedTarget = emp;
            
            document.getElementById('targetName').value = emp.name;
            document.getElementById('targetEmail').value = emp.email;
            document.getElementById('targetPhone').value = emp.phone;
            document.getElementById('targetTeam').value = emp.team;
            
            document.getElementById('startBtn').disabled = false;
        }

        function validateTargetInput() {
            const input = document.getElementById('targetSearchInput');
            if (!selectedTarget || input.value !== selectedTarget.name) {
                const exactMatch = eligibleTargets.find(e => e.name === input.value);
                if (exactMatch) selectTarget(exactMatch);
                else {
                    input.value = "";
                    selectedTarget = null;
                    document.getElementById('startBtn').disabled = true;
                }
            }
        }

        // --- SURVEY LOGIC ---
        function initSurvey() {
            if(!selectedGroup || !selectedTarget) { alert("Please select Group and Target."); return; }
            
            document.getElementById('displayGroup').innerText = selectedGroup;
            document.getElementById('displayTarget').innerText = selectedTarget.name;

            renderSurvey(fetchedQuestions);
            showPage('surveyPage');
            window.scrollTo(0,0);
        }

        function cancelAssessment() {
            showPage('introPage');
        }

        function renderSurvey(questions) {
            const container = document.getElementById('questionsContainer');
            let html = "";
            let grouped = {}; questions.forEach(q => { if(!grouped[q.category]) grouped[q.category]=[]; grouped[q.category].push(q); });
            
            let idx = 1;
            categoryOrder.forEach(cat => {
                if(grouped[cat]) {
                    html += `<div class="section-header"><span>${cat}</span></div>`;
                    grouped[cat].forEach(q => {
                        html += `
                        <div class="question-item">
                            <div class="question-text">${idx}. ${q.text}</div>
                            <div class="scale-line-wrapper">
                                <div class="scale-label-side scale-label-left">Sangat Tidak Setuju</div>
                                <div class="scale-options">
                                    <div class="scale-track"></div>
                                    ${[0,25,50,75,100].map(v => `
                                        <label class="scale-option">
                                            <input type="radio" name="qid_${q.id}" data-cat="${cat}" data-rev="${q.reversed}" value="${v}" required title="Score: ${v}">
                                        </label>
                                    `).join('')}
                                </div>
                                <div class="scale-label-side scale-label-right">Sangat Setuju</div>
                            </div>
                        </div>`;
                        idx++;
                    });
                }
            });
            container.innerHTML = html;
        }

        function toggleDetails() {
            const container = document.getElementById('resultDetailAnswers');
            const btn = document.getElementById('btnToggleDetail');
            
            if (container.style.display === "none") {
                container.style.display = "block";
                btn.innerHTML = "Tutup Detail Jawaban &#9650;"; 
            } else {
                container.style.display = "none";
                btn.innerHTML = "Lihat Detail Jawaban &#9660;"; 
            }
        }

        async function calculateAndSubmit() {
            const inputs = document.querySelectorAll('input[type="radio"]:checked');
            if(inputs.length < fetchedQuestions.length) { document.getElementById('errorMsg').style.display = 'block'; return; }
            document.getElementById('errorMsg').style.display = 'none';

            let scoresObj = {}; categoryOrder.forEach(c => scoresObj[c] = {sum:0, count:0});
            let detailAnswers = [];
            
            inputs.forEach(inp => {
                let val = parseInt(inp.value); if(inp.getAttribute('data-rev') === 'true') val = 100 - val;
                let cat = inp.getAttribute('data-cat'); 
                if(scoresObj[cat]) { scoresObj[cat].sum += val; scoresObj[cat].count++; }
                detailAnswers.push({ q_id: inp.name.replace('qid_', ''), score: val });
            });

            let habitScores = []; let total = 0;
            categoryOrder.forEach(c => { 
                let s = scoresObj[c]; 
                let avg = s.count ? Math.round(s.sum/s.count) : 0; 
                habitScores.push(avg); total += avg; 
            });
            let grandTotal = Math.round(total / categoryOrder.length);

            const payload = {
                assessor: { 
                    name: selectedGroup, 
                    email: "group-assessment@system.local" 
                },
                target: { 
                    name: document.getElementById('targetName').value, 
                    email: document.getElementById('targetEmail').value, 
                    phone: document.getElementById('targetPhone').value, 
                    team: document.getElementById('targetTeam').value 
                },
                summary: { totalScore: grandTotal, habitScores: habitScores },
                answers: detailAnswers
            };

            let chartHtml = "";
            categoryOrder.forEach((cat, i) => {
                const s = habitScores[i];
                let color = s >= 80 ? "#27ae60" : (s >= 60 ? "#f39c12" : "#e74c3c");
                chartHtml += `
                <div class="result-row">
                    <div class="result-label">${cat}</div>
                    <div class="result-bar-area">
                        <div class="result-bar-fill" style="width: ${s}%; background-color: ${color}"></div>
                    </div>
                    <div class="result-score" style="color:${color}">${s}</div>
                </div>`;
            });
            document.getElementById('resultSummaryChart').innerHTML = chartHtml;

            const ansMap = {}; detailAnswers.forEach(d => ansMap[d.q_id] = d.score);
            let grouped = {}; fetchedQuestions.forEach(q => { if(!grouped[q.category]) grouped[q.category]=[]; grouped[q.category].push(q); });
            
            let detailHtml = ""; let idx = 1;
            categoryOrder.forEach(cat => {
                if(grouped[cat]) {
                    detailHtml += `<div class="section-header"><span>${cat}</span></div>`;
                    grouped[cat].forEach(q => {
                        const userScore = ansMap[q.id];
                        detailHtml += `
                        <div class="question-item" style="background-color:#fff;">
                            <div class="question-text" style="color:#555;">${idx}. ${q.text}</div>
                            <div class="scale-line-wrapper">
                                <div class="scale-label-side scale-label-left">Sangat Tidak Setuju</div>
                                <div class="scale-options">
                                    <div class="scale-track"></div>
                                    ${[0, 25, 50, 75, 100].map(v => {
                                        let rawValue = userScore;
                                        if (userScore !== undefined && q.reversed === true) {
                                            rawValue = 100 - userScore;
                                        }
                                        const isChecked = (rawValue === v) ? 'checked' : '';
                                        const opacity = isChecked ? '1' : '0.3';
                                        return `<label class="scale-option" style="cursor: default;">
                                            <input type="radio" disabled ${isChecked} style="cursor: default; opacity: ${opacity}; accent-color: var(--primary);">
                                        </label>`;
                                    }).join('')}
                                </div>
                                <div class="scale-label-side scale-label-right">Sangat Setuju</div>
                            </div>
                        </div>`;
                        idx++;
                    });
                }
            });
            document.getElementById('resultDetailAnswers').innerHTML = detailHtml;
            document.getElementById('resultDetailAnswers').style.display = "none";
            document.getElementById('btnToggleDetail').innerHTML = "Lihat Detail Jawaban &#9660;";

            const res = await saveToGoogleSheet(payload);
            
            if (res.status === 'success') {
                // Update local state (NAME-based)
                submittedPairs.push({ 
                    assessor: selectedGroup.toLowerCase(), 
                    target: payload.target.name.toLowerCase().trim() // IMPORTANT: Save NAME not Email
                });

                document.getElementById('resTargetName').innerText = payload.target.name;
                document.getElementById('finalScoreDisplay').innerText = grandTotal;
                showPage('resultPage');
            } else {
                alert("Submission failed. Check internet connection.");
            }
        }

        function continueAssessment() {
            showPage('introPage');
            updateEligibleTargets(); 
            
            const targetInput = document.getElementById('targetSearchInput');
            targetInput.value = "";
            selectedTarget = null;
            document.getElementById('startBtn').disabled = true;
        }
        
        function showPage(id) { document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }
    </script>
</body>
</html>
